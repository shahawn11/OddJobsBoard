<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Odd Jobs Board</title>
    <style>
        /* Reset CSS */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f7f7f7;
            color: #333;
            line-height: 1.6;
            position: relative; /* Added position relative to the body */
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        .header {
            background-color: #007bff;
            padding: 20px 0;
            display: flex;
            justify-content: space-between;
            align-items:center
        }

        .header__title {
            color: #fff;
        }

        .login-button {
            background-color: #28a745;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-right: 10px;
        }

        .login-button:hover {
            background-color: #218838;
        }

        /* Main */
        .main {
            padding: 20px 0;
        }

        .search {
            margin-bottom: 20px;
            display: flex;
        }

        .search__input {
            flex: 1;
            padding: 10px;
            border: 2px solid #007bff;
            border-radius: 5px 0 0 5px;
            font-size: 16px;
        }

        .search__button {
            padding: 10px 20px;
            background-color: #007bff;
            border: none;
            border-radius: 0 5px 5px 0;
            color: #fff;
            cursor: pointer;
            font-size: 16px;
        }

        .existing-jobs {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: flex-start;
        }

        .job {
            width: calc(20% - 20px);
            background-color: #fff; /* White job container */
            border: 1px solid #ccc; /* Border color */
            padding: 20px;
            border-radius: 10px;
            box-sizing: border-box;
            text-align: center;
            margin-bottom: 20px;
        }

        .job h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 20px;
            color: #333;
        }

        .job p {
            color: #666;
            margin-bottom: 10px;
        }

        .job button {
            background-color: #28a745; /* Green button for job acceptance */
            color: #fff;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .job button:hover {
            background-color: #218838; /* Darker green on hover */
        }

        .hidden {
            display: none;
        }

        .add-job-btn {
            display: block;
            width: 100%;
            padding: 15px 20px;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            color: #fff;
            cursor: pointer;
            font-size: 18px;
            transition: background-color 0.3s ease;
            margin-bottom: 20px; /* Spacing between the button and existing jobs */
        }

        .add-job-btn:hover {
            background-color: #0056b3;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 18px;
            margin-bottom: 5px;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .form-btn {
            display: block;
            width: 100%;
            padding: 15px 20px;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            color: #fff;
            cursor: pointer;
            font-size: 18px;
            transition: background-color 0.3s ease;
        }

        .form-btn:hover {
            background-color: #0056b3;
        }

        /* Footer */
        .footer {
            background-color: #007bff;
            padding: 20px 0;
            color: #fff;
            text-align: center;
        }

        .footer__text {
            font-size: 16px;
        }

        button:disabled {
  /* your styling here */
  opacity: 0.5; /* example: reduce opacity to indicate disabled state */
  cursor: not-allowed; /* example: change cursor to indicate disabled state */
}

/* Chat window */
.chat-window {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background-color: #fff;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    padding: 10px;
    width: 300px;
    max-height: 400px;
    overflow-y: auto;
    z-index: 1000;
}

.chat-window__title {
    font-size: 20px;
    font-weight: bold;
    margin: 0 auto; /* Center the header text */
    padding: 5px 10px;
    background-color: #f7f7f7;
    border-bottom: 2px solid #333; /* Darker border color */
    border-radius: 5px 5px 0 0;
    text-align: center; /* Center the text */
    margin-bottom: 10px;
}


/* Chat element */
.chat {
    margin-bottom: 10px; /* Add spacing between each chat */
    border-bottom: 1px solid #ccc; /* Add border between each chat */
}




/* Chatbox */
.chatbox {
    position: fixed;
    left: 20px;
    bottom: 20px;
    width: 300px;
    background-color: #fff;
    border: 1px solid #ccc;
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    padding: 10px;
    height: 400px; /* Set a maximum height for the chatbox */
    overflow: hidden; /* Hide overflow to ensure scrollbars are visible only when needed */
    z-index: 999; /* Adjusted z-index to ensure it's below the chat window */
    display: flex;
    flex-direction: column;
}

/* Job title */
.chatbox .chatbox-header {
    font-size: 20px;
    font-weight: bold;
    margin: 0;
    padding: 5px 10px;
    background-color: #f7f7f7;
    border-bottom: 1px solid #ccc;
    border-radius: 5px 5px 0 0;
}

/* CSS for Chatbox Messages */
.chatbox-messages {
    flex: 1; /* Let the messages container grow to fill available space */
    overflow-y: auto; /* Add vertical scrollbar when needed */
    display: flex; /* Ensure message elements are flex items */
    flex-direction: column; /* Stack messages vertically */
    padding: 5px 10px;
    padding-left: 2px;
    padding-right: 2px;
}

/* CSS for Message Elements */
.chatbox-messages div {
    padding: 5px;
    background-color: #696969;
    color: #fcfafa;
    border-radius: 5px;
    margin-bottom: 5px;
    align-self: flex-start; /* Align all messages to the left by default */
}

/* CSS for Messages Sent by You */
.chatbox-messages .sent-by-you {
    align-self: flex-end; /* Align messages sent by you to the right */
    background-color: #007bff; /* Background color for messages sent by you */
    color: #fcfafa; /* Text color for messages sent by you */
}


/* Message Input Container */
.message-input-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 10px; /* Separate from chat messages */
    padding-top: 10px; /* Add padding at the top */
}

/* Message Input */
.message-input {
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 14px;
    margin-right: 10px; /* Add margin between input field and send button */
}

/* Send Button */
.sendButton {
    padding: 8px 15px;
    background-color: #007bff;
    border: none;
    border-radius: 5px;
    color: #fff;
    cursor: pointer;
    font-size: 14px;
}

.sendButton:hover {
    background-color: #0056b3;
}

    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <h1 class="header__title">Odd Jobs Board</h1>
        </div>
        <div align="right"> 
            <a id="loginButton" href="login.html" class="login-button">Login</a>
            <button id="logoutButton" onclick="logout()" class="login-button">Logout</button>
        </div>
    </header>
    
    <main class="main">
        <div class="container">
            <div class="search">
                <input type="text" id="searchInput" class="search__input" placeholder="Search for Jobs">
                <button type="button" class="search__button" onclick="searchJobs()">Search</button>
            </div>

            <button id="addJobBtn" class="add-job-btn">Add a Job</button>

            <form id="postJobForm" class="hidden">
                <div class="form-group">
                    <label for="jobTitle" class="form-label">Job Title:</label>
                    <input type="text" id="jobTitle" class="form-input" name="jobTitle" required>
                </div>
                <div class="form-group">
                    <label for="jobDescription" class="form-label">Job Description:</label>
                    <textarea id="jobDescription" class="form-input" name="jobDescription" rows="4" required></textarea>
                </div>
                <div class="form-group">
                    <label for="jobLocation" class="form-label">Location:</label>
                    <input type="text" id="jobLocation" class="form-input" name="jobLocation" required>
                </div>
                <button type="submit" class="form-btn">Post Job</button>
            </form>

            <section class="existing-jobs" id="jobList"></section>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p class="footer__text">&copy; 2024 Odd Jobs Board. All rights reserved.</p>
        </div>
    </footer>

<!-- Chat window -->
<div id="chatWindow" class="chat-window">
    <h2 class="chat-window__title">Chats</h2>
    <!-- Existing chats will be appended here -->
</div>


    <script>
        // Define the API Gateway URL
        const apiUrl = APIURL;

// Function to fetch and display posted jobs
async function displayJobs() {
    try {
        const response = await fetch(apiUrl + '/jobs');
        const data = await response.json();

        // Parse the JSON-encoded string into a JavaScript object
        const jobs = JSON.parse(data.body);

        // Check if jobs is an array
        if (Array.isArray(jobs)) {
            const jobList = document.getElementById('jobList');
            jobList.innerHTML = '';

            const userId = localStorage.getItem('userId');
            
            // Get all chat elements
            const chatElements = document.querySelectorAll('.chat');

            jobs.forEach(job => {
                if (job.posterId === userId) {
                    // Skip creating the button if the user posted the job
                    const jobElement = document.createElement('div');
                    jobElement.classList.add('job');
                    jobElement.innerHTML = `
                        <h3>${job.title}</h3>
                        <p>${job.description}</p>
                        <p><strong>Location:</strong> ${job.location}</p>
                        <button disabled class="job-accepted-btn">Job Posted</button>
                    `;
                    jobList.appendChild(jobElement);
                 } else {
                const jobElement = document.createElement('div');
                jobElement.classList.add('job');
                jobElement.innerHTML = `
                    <h3>${job.title}</h3>
                    <p>${job.description}</p>
                    <p><strong>Location:</strong> ${job.location}</p>
                    ${isJobAccepted(job.jobId, chatElements) ? '<button disabled>Job Accepted</button>' : '<button onclick="acceptJob(\'' + job.jobId + '\')">Accept Job</button>'}
                `;
                jobList.appendChild(jobElement);
                }
            });
        } else {
            console.error('Invalid response format: jobs is not an array');
        }
    } catch (error) {
        console.error('Error fetching jobs:', error);
    }
}

// Function to check if a job has been accepted based on chat elements
function isJobAccepted(jobId, chatElements) {
    for (const chatElement of chatElements) {
        if (chatElement.dataset.jobId === jobId) {
            return true;
        }
    }
    return false;
}


        // Function to search for jobs
        async function searchJobs() {
            const searchInput = document.getElementById('searchInput').value.toLowerCase();

            const response = await fetch(apiUrl + '/jobs');
            const data = await response.json();

            const allJobs = JSON.parse(data.body);

            const searchResults = allJobs.filter(job => {
                return job.title.toLowerCase().includes(searchInput) ||
                    job.description.toLowerCase().includes(searchInput) ||
                    job.location.toLowerCase().includes(searchInput);
            });

            const jobList = document.getElementById('jobList');
            jobList.innerHTML = '';

            const userId = localStorage.getItem('userId');
            
            // Get all chat elements
            const chatElements = document.querySelectorAll('.chat');

            searchResults.forEach(job => {
                if (job.posterId === userId) {
                    // Skip creating the button if the user posted the job
                    const jobElement = document.createElement('div');
                    jobElement.classList.add('job');
                    jobElement.innerHTML = `
                        <h3>${job.title}</h3>
                        <p>${job.description}</p>
                        <p><strong>Location:</strong> ${job.location}</p>
                        <button disabled class="job-accepted-btn">Job Posted</button>
                    `;
                    jobList.appendChild(jobElement);
                 } else {
                const jobElement = document.createElement('div');
                jobElement.classList.add('job');
                jobElement.innerHTML = `
                    <h3>${job.title}</h3>
                    <p>${job.description}</p>
                    <p><strong>Location:</strong> ${job.location}</p>
                    ${isJobAccepted(job.jobId, chatElements) ? '<button disabled>Job Accepted</button>' : '<button onclick="acceptJob(\'' + job.jobId + '\')">Accept Job</button>'}
                `;
                jobList.appendChild(jobElement);
                }
            });
        }

        // Function to submit a new job
        async function postJob(event) {
                // Fetch the session token from local storage
    const sessionToken = localStorage.getItem('token');

// Check if session token exists
if (!sessionToken) {
    console.error('Session token not found');
    window.alert("Please log in");
    window.location.href = 'login.html';
    return; // Exit function if session token is not found
}

// Extract userId from session token
const userId = localStorage.getItem('userId');

// Check if userId was successfully extracted
if (!userId) {
    console.error('Unable to extract userId from token');
    window.alert("Please log in");
    window.location.href = 'login.html';
    return; // Exit function if userId extraction fails
}

// Get job details from the form or any other source
const jobTitle = document.getElementById('jobTitle').value;
const jobDescription = document.getElementById('jobDescription').value;
const jobLocation = document.getElementById('jobLocation').value;

// Prepare the request body including userId
const requestBody = {
    userId: userId,
    title: jobTitle,
    description: jobDescription,
    location: jobLocation
    // Add more fields as needed
};
            const response = await fetch(apiUrl + '/jobs', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
                });

            if (response.ok) {
                // Job posted successfully, refresh job list
                displayJobs();
                document.getElementById('postJobForm').reset();
            } else {
                alert('Failed to post job');
            }
        }

// Function to accept a job
async function acceptJob(jobId) {
    const sessionToken = localStorage.getItem('token');

// Check if session token exists
if (!sessionToken) {
    console.error('Session token not found');
    window.location.href = 'login.html';
    return; // Exit function if session token is not found
}

// Extract userId from session token
const userId = localStorage.getItem('userId');

    const response = await fetch(apiUrl + `/jobs/${jobId}/accept`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            userId: localStorage.getItem('userId'), // Include the user ID in the request body
            jobId: jobId // Include the job ID in the request body
        })
    });

    if (response.ok) {
        const jobData = await response.json();
        const body = JSON.parse(jobData.body); 
        const chatId = body.chatId;
        const jobTitle = body.title;
        // Create a chat with the job poster
        createChat(chatId, jobTitle, jobId);
        displayJobs();
        alert('Job accepted');
    } else {
        alert('Failed to accept job');
    }
}


// Function to create a chat with the job poster
function createChat(chatId, jobTitle, jobId) {
    const chatWindow = document.getElementById('chatWindow');
    const chatElement = document.createElement('div');
    chatElement.classList.add('chat');
    chatElement.dataset.chatId = chatId; // Set the data-chatId attribute
    chatElement.dataset.jobTitle = jobTitle;
    chatElement.dataset.jobId = jobId;
    chatElement.innerHTML = `
        <h3>${jobTitle}</h3>
        </div>
    `;

    // Add event listener to open the chatbox when clicked
    chatElement.addEventListener('click', () => {
        const chatElement = event.target.closest('.chat')
        const chatId = chatElement.dataset.chatId;
        const jobTitle = chatElement.dataset.jobTitle;

        openChatbox(chatId, jobTitle);
    });

    chatWindow.appendChild(chatElement);

}


// Function to display a list of chats in the chat window
async function displayChats(userId) {
    try {
        // Fetch user's chats
        const response = await fetch(apiUrl + `/user/${userId}/chats`);
        const chats = await response.json();

        const chatWindow = document.getElementById('chatWindow');
        //chatWindow.innerHTML = ''; // Clear previous chat windows

        chats.forEach(chat => {
            createChat(chat.chatId, chat.title, chat.jobId); // Call createChat function for each chat
        });
    } catch (error) {
        console.error('Error displaying chats:', error);
    }
}


        // Display the form to add a job when the "Add a Job" button is clicked
        document.getElementById('addJobBtn').addEventListener('click', function() {
            document.getElementById('postJobForm').classList.toggle('hidden');
        });

        // Display posted jobs when the page loads
        window.onload = displayJobs;

        if (localStorage.getItem('token')) {
            const userId = localStorage.getItem('userId');
            displayChats(userId);
        }

        // Attach event listener to the form submission
        document.getElementById('postJobForm').addEventListener('submit', postJob);

        document.getElementById('searchInput').addEventListener('keypress', function(event) {
            if (event.keyCode === 13) { // Check if Enter key was pressed
                searchJobs(); // Call the search function
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
    // Check if the user is logged in
    const token = localStorage.getItem('token');
    const loginButton = document.getElementById('loginButton');
    const logoutButton = document.getElementById('logoutButton');

    if (token) {
        // User is logged in
        loginButton.style.display = 'none'; // Hide login button
        logoutButton.style.display = 'block'; // Show logout button
    } else {
        // User is not logged in
        loginButton.style.display = 'block'; // Show login button
        logoutButton.style.display = 'none'; // Hide logout button
    }
});

// Function to handle logout
function logout() {
    // Remove token from local storage
    localStorage.removeItem('token');

    // Redirect to login page or perform other actions
    window.location.href = 'login.html';
}

// Function to fetch and display chat messages for a specific chat
async function fetchChatMessages(chatId) {
    try {
        const response = await fetch(apiUrl + `/chat/${chatId}/messages`);
        if (!response.ok) {
            throw new Error('Failed to fetch chat messages');
        }

        const messages = await response.json(); // Response is an array of message objects

        // Get the chatbox messages container
        const chatboxMessages = document.querySelector('.chatbox-messages');

        // Clear any existing messages
        chatboxMessages.innerHTML = '';

        // Render messages in the chatbox
        if (messages.length > 0) {
            messages.forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.textContent = message.content;

                // Add a CSS class based on whether the message is sent by the current user or another user
                if (message.senderId === localStorage.getItem('userId')) {
                    messageElement.classList.add('sent-by-you');
                } else {
                    messageElement.classList.add('sent-by-other');
                }

                chatboxMessages.appendChild(messageElement);
            });
        }
    } catch (error) {
        console.error('Error fetching chat messages:', error);
    }
}



// Function to send a message to the chat room
async function sendMessage(chatId, text) {
    try {
        // Retrieve userId from local storage
        const userId = localStorage.getItem('userId');

        // Check if userId exists
        if (!userId) {
            console.error('User ID not found in local storage');
            return;
        }

        const response = await fetch(apiUrl + `/chat/${chatId}/messages`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ chatId, userId, content: text }) // Include chatId, userId, and content in the request body
        });

        if (response.ok) {
            const { message } = await response.json(); // Destructure the response object to extract the message
            // Display the sent message in the chatbox
            const chatboxMessages = document.querySelector('.chatbox-messages');
            const messageElement = document.createElement('div');
            messageElement.textContent = text;
            await fetchChatMessages(chatId);
            // Scroll to the bottom of the chat messages container
            chatboxMessages.scrollTop = chatboxMessages.scrollHeight;
        } else {
            console.error('Failed to send message:', response.status);
            alert('Failed to send message. Please try again later.');
        }
    } catch (error) {
        console.error('Error sending message:', error);
        alert('An unexpected error occurred while sending the message.');
    }
}


// Function to display the chatbox with messages for a specific chat
async function openChatbox(chatId, jobTitle) {
    const existingChatbox = document.querySelector('.chatbox');
    if (existingChatbox) {
        existingChatbox.remove();
    }

    // Create the chatbox elements
    const chatbox = document.createElement('div');
    chatbox.classList.add('chatbox');
    chatbox.classList.remove('hidden'); // Ensure the chatbox is visible

    const chatboxHeader = document.createElement('div');
    chatboxHeader.classList.add('chatbox-header');
    chatboxHeader.textContent = jobTitle;

    const chatboxMessages = document.createElement('div');
    chatboxMessages.classList.add('chatbox-messages');

    chatbox.dataset.chatId = chatId;

    // Create message input and send button
    const messageInput = document.createElement('input');
    messageInput.setAttribute('type', 'text');
    messageInput.classList.add('message-input');
    messageInput.setAttribute('placeholder', 'Type your message');

    const sendButton = document.createElement('button');
    sendButton.textContent = 'Send';
    sendButton.classList.add('sendButton');

    // Create close button
    const closeButton = document.createElement('button');
    closeButton.textContent = 'Close';
    closeButton.classList.add('close-button');

    // Event listener for the close button
    closeButton.addEventListener('click', function() {
        chatbox.remove(); // Remove the chatbox when the close button is clicked
    });

    // Event listener for the send button
    sendButton.addEventListener('click', function() {
        const messageText = messageInput.value.trim();
        if (messageText) {
            sendMessage(chatId, messageText); // Pass the chatId when sending the message
            messageInput.value = ''; // Clear the input field after sending the message
        }
    });

    // Event listener for the Enter key press in the message input field
messageInput.addEventListener('keypress', function(event) {
    if (event.key === 'Enter') { // Check if Enter key was pressed
        const messageText = messageInput.value.trim();
        if (messageText) {
            sendMessage(chatId, messageText); // Pass the chatId when sending the message
            messageInput.value = ''; // Clear the input field after sending the message
        }
    }
});


    // Append chatbox elements to the chat window
    chatbox.appendChild(closeButton);
    chatbox.appendChild(chatboxHeader);
    chatbox.appendChild(chatboxMessages);
    chatbox.appendChild(messageInput);
    chatbox.appendChild(sendButton);
    
    const chatWindow = document.getElementById('chatWindow');
    chatWindow.appendChild(chatbox);

    // Fetch and display old messages
    await fetchChatMessages(chatId);
    // Scroll to the bottom of the chat messages container
    chatboxMessages.scrollTop = chatboxMessages.scrollHeight;
}


// Function to periodically fetch chat messages if a chatbox is open
function fetchChatMessagesIfOpen() {
    const existingChatbox = document.querySelector('.chatbox');
    if (existingChatbox) {
        const currentChatId = existingChatbox.dataset.chatId;
        fetchChatMessages(currentChatId);
    }
}

// Interval in milliseconds to fetch chat messages (e.g., every 5 seconds)
const fetchInterval = 5000;

// Start fetching chat messages at the specified interval
const fetchIntervalId = setInterval(fetchChatMessagesIfOpen, fetchInterval);

</script>
</body>
</html>